// ุงุณุชูุฑุงุฏ ูุญุฏุงุช Firebase ุงููุทููุจุฉ ูู ููุชุจุฉ Firebase ุงูุฅุตุฏุงุฑ 9.6.1
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"; // ุชููุฆุฉ ุงูุชุทุจูู
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"; // ุฅุฏุงุฑุฉ ุงููุตุงุฏูุฉ
import { getDatabase, ref, update, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"; // ุฅุฏุงุฑุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช

// ุชูููู Firebase ุจุงุณุชุฎุฏุงู ุงูุฅุนุฏุงุฏุงุช ุงูุฎุงุตุฉ ุจุงููุดุฑูุน
const firebaseConfig = {
    apiKey: "AIzaSyB9ZqQCZG9g3qclDz-kLHrNQparJT_iBXc", // ููุชุงุญ API ูุชุญุฏูุฏ ุงููุดุฑูุน
    authDomain: "mypro-d8761.firebaseapp.com", // ูุทุงู ุงููุตุงุฏูุฉ
    databaseURL: "https://mypro-d8761-default-rtdb.firebaseio.com", // ุฑุงุจุท ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู Firebase
    projectId: "mypro-d8761", // ูุนุฑู ุงููุดุฑูุน ูู Firebase
    storageBucket: "mypro-d8761.appspot.com", // ุชุฎุฒูู ุงููููุงุช ูุงููุณุงุฆุท
    messagingSenderId: "439741574644", // ูุนุฑู ุฅุฑุณุงู ุงูุฑุณุงุฆู ุงูุณุญุงุจูุฉ
    appId: "1:439741574644:web:50b693546c7d32a5579da1" // ูุนุฑู ุงูุชุทุจูู
};

// ุชููุฆุฉ ุงูุชุทุจูู ุจุงุณุชุฎุฏุงู ุงูุชูููู ุงูุณุงุจู
const app = initializeApp(firebaseConfig);

// ุงูุญุตูู ุนูู ูุงุฆู ุงููุตุงุฏูุฉ ูุฅุฏุงุฑุฉ ุชุณุฌูู ุงูุฏุฎูู ูุงูุฎุฑูุฌ
const auth = getAuth(app);

// ุงูุญุตูู ุนูู ูุงุฆู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุชุนุงูู ูุน ุงูุจูุงูุงุช ุงููุฎุฒูุฉ
const db = getDatabase(app);

// ุงูุชุญูู ูู ุญุงูุฉ ุงููุณุชุฎุฏู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ุฃู ุงูุฎุฑูุฌ
onAuthStateChanged(auth, (user) => {
    if (user) {
        // ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌูุงู ุงูุฏุฎูู
        console.log("ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู:", user.uid); // ุทุจุงุนุฉ ูุนุฑู ุงููุณุชุฎุฏู ูู ูุญุฏุฉ ุงูุชุญูู

        // ุฅูุดุงุก ูุฑุฌุน ูุจูุงูุงุช ุงููุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        const userRef = ref(db, 'users/' + user.uid);

        // ุชุนุฑูู ุฏุงูุฉ ูุญูุธ ุจูุงูุงุช ุงููููุน ูุงูุณุฑุนุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        window.saveToDB = (lat, lng, speed, heading) => {
            console.log("ุญูุธ ุงูุจูุงูุงุช ูููุณุชุฎุฏู:", user.uid, { lat, lng, speed, heading });

            // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            update(userRef, {
                latitude: lat, // ุญูุธ ุฎุท ุงูุนุฑุถ
                longitude: lng, // ุญูุธ ุฎุท ุงูุทูู
                speed: speed, // ุญูุธ ุงูุณุฑุนุฉ
                heading: heading, // ุญูุธ ุงุชุฌุงู ุงูุญุฑูุฉ
                timestamp: Date.now() // ุญูุธ ุงูุทุงุจุน ุงูุฒููู ููููุช ุงูุญุงูู
            }).then(() => {
                console.log("ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ"); // ุชุฃููุฏ ูุฌุงุญ ุงูุญูุธ
            }).catch((error) => {
                console.error('ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', error); // ุทุจุงุนุฉ ุงูุฎุทุฃ ุฅุฐุง ูุดู ุงูุญูุธ
            });

            
            // ูุฑุงูุจุฉ ุจูุงูุงุช ุงููุณุชุฎุฏู ูุชุญุฏูุซูุง ูู ุงููุงุฌูุฉ ุนูุฏ ุชุบููุฑูุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val(); // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                
                // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู ุงููุชุบูุฑ ุงูุนุงู ููุชู ุงุณุชุฎุฏุงููุง ูู ุงููุงุฌูุฉ
                window.userInfo = {
                    username: userData?.username || 'ุบูุฑ ูุนุฑูู', // ุฌูุจ ุงุณู ุงููุณุชุฎุฏู ุฃู ุชุนูููู ูู "ุบูุฑ ูุนุฑูู"
                    email: user.email, // ุฌูุจ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุณุชุฎุฏู
                    speed: userData?.speed || 0, // ุฌูุจ ุงูุณุฑุนุฉ ุฃู ุชุนููููุง ุฅูู 0 ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
                    heading: userData?.heading || 0, // ุฌูุจ ุงูุงุชุฌุงู ุฃู ุชุนูููู ุฅูู 0 ุฅุฐุง ูู ููู ููุฌูุฏูุง
                    coords: userData ? [userData.latitude, userData.longitude] : [0, 0] // ุญูุธ ุงูุฅุญุฏุงุซูุงุช ุฃู ุชุนููููุง ุฅูู [0,0] ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
                };
            });

            // ูุฑุงูุจุฉ ุฌููุน ุงูููุงูุน ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนุฑุถูุง ุนูู ุงูุฎุฑูุทุฉ
            const locationsRef = ref(db, 'locations');
            console.log("save");

        
            













// ุฅูุดุงุก ุฃููููุฉ ุณูู ุฏูุงุฑ ููุฅุดุงุฑุฉ ุฅูู ุงุชุฌุงู ุงููุณุชุฎุฏููู
function createArrowIcon(heading) {
    return L.divIcon({
        className: 'rotating-arrow', // ุงููุฆุฉ ุงูุฎุงุตุฉ ุจุงูุชุตููู
        iconSize: [30, 30], // ุญุฌู ุงูุฃููููุฉ
        iconAnchor: [15, 15], // ููุทุฉ ุชุซุจูุช ุงูุฃููููุฉ
        html: `<div class="arrow" style="transform: rotate(${heading}deg);"></div>` // ุชุฏููุฑ ุงูุณูู ููู ุงูุงุชุฌุงู
    });
}

// ูุฑุงูุจุฉ ุฌููุน ุงูููุงูุน ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนุฑุถูุง ุนูู ุงูุฎุฑูุทุฉ
const usersRef = ref(db, 'users');

onValue(usersRef, (snapshot) => {
    console.log("๐ก ุงุณุชูุงู ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:", snapshot.val());
    const users = snapshot.val();

    if (!users || Object.keys(users).length === 0) {
        console.log("โ๏ธ ูุง ุชูุฌุฏ ููุงูุน ูุชุงุญุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.");
        return;
    }

    window.locationsCache = JSON.stringify(users);

    // ุฅุฒุงูุฉ ุงููุงุฑูุฑุงุช ุงููุฏููุฉ
    if (window.locationsMarkers) {
        window.locationsMarkers.forEach(marker => map.removeLayer(marker));
    }
    window.locationsMarkers = [];

    // ุฅุถุงูุฉ ูุงุฑูุฑ ููู ูุณุชุฎุฏู ูุฏูู ูููุน ูุณุฌู
    Object.entries(users).forEach(([userId, userData]) => {
        if (userData.latitude && userData.longitude) {
            const heading = userData.heading || 0; // ุงูุงุชุฌุงู ุงูุงูุชุฑุงุถู 0 ุฅุฐุง ูู ููู ูุชุงุญูุง

            const locationMarker = L.marker([userData.latitude, userData.longitude], {
                icon: createArrowIcon(heading) // ุงุณุชุฎุฏุงู ุฃููููุฉ ุงูุณูู ุจุฏูุงู ูู ุงูุฃููููุฉ ุงูุงูุชุฑุงุถูุฉ
            }).bindPopup(`
                <div dir="rtl">
                    <b>ุงุณู ุงููุณุชุฎุฏู:</b> ${userData.username || 'ุบูุฑ ูุนุฑูู'}<br>
                    <b>ุงูุฅูููู:</b> ${userData.email || 'ุบูุฑ ูุชุงุญ'}<br>
                    <b>ุงูุณุฑุนุฉ:</b> ${userData.speed || 'ุบูุฑ ูุชุงุญุฉ'} ูู/ุณ<br>
                    <b>ุงูุงุชุฌุงู:</b> ${heading}ยฐ<br>
                    <b>ุงูุฅุญุฏุงุซูุงุช:</b> ${userData.latitude.toFixed(4)}, ${userData.longitude.toFixed(4)}
                </div>
            `).addTo(map);

            window.locationsMarkers.push(locationMarker);
        }
    });
});




        };
    } else {
        // ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ูุณุฌูุงู ุงูุฏุฎููุ ูุชู ุชูุฌููู ุฅูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
        window.location.href = "login.html";
    }
});

// ุฅุถุงูุฉ ุญุฏุซ ูุชุณุฌูู ุงูุฎุฑูุฌ ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ุงูุฎุฑูุฌ
document.querySelector('.logout-btn').addEventListener('click', async () => {
    try {
        await signOut(auth); // ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู ูู Firebase
        window.location.href = 'login.html'; // ุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏู ุฅูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
    } catch (error) {
        console.error("ุฎุทุฃ ูู ุชุณุฌูู ุงูุฎุฑูุฌ:", error); // ุทุจุงุนุฉ ุงูุฎุทุฃ ูู ูุญุฏุฉ ุงูุชุญูู ุฅุฐุง ูุดู ุชุณุฌูู ุงูุฎุฑูุฌ
        alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุชุณุฌูู ุงูุฎุฑูุฌ"); // ุนุฑุถ ุฑุณุงูุฉ ุชูุจูููุฉ ูููุณุชุฎุฏู
    }
});

// ุฅูุดุงุก ุฃููููุฉ ุณูู ุฏูุงุฑ ููุฅุดุงุฑุฉ ุฅูู ุงูุงุชุฌุงู ุนูู ุงูุฎุฑูุทุฉ
const arrowIcon = L.divIcon({
    className: 'rotating-arrow', // ุชุนููู ุงุณู ุงููุฆุฉ ุงูุฎุงุตุฉ ุจุงูุฃููููุฉ (ูุชู ุงูุชุญูู ุจูุง ุนุจุฑ CSS)
    iconSize: [30, 30], // ุญุฌู ุงูุฃููููุฉ (ุนุฑุถ ร ุงุฑุชูุงุน)
    iconAnchor: [15, 15], // ููุทุฉ ุชุซุจูุช ุงูุฃููููุฉ (ุงูููุงู ุงูุฐู ูุชู ูุถุนูุง ููู ุนูู ุงูุฎุฑูุทุฉ)
    html: '<div class="arrow"></div>' // ูุญุชูู ุงูุฃููููุฉุ ููุง ูุชู ุชูุซูููุง ุจุนูุตุฑ div ูุงุจู ููุชุฎุตูุต ุนุจุฑ CSS
});

// ุฅูุดุงุก ุฎุฑูุทุฉ Leaflet ูุน ุฅูุบุงุก ุงูุชุญูู ูู ุงูุชูุจูุฑ ุงูุงูุชุฑุงุถู
let map = L.map('map', {
    zoomControl: false // ุชุนุทูู ุฒุฑ ุงูุชุญูู ูู ุงูุชูุจูุฑ ูุงูุชุตุบูุฑ ุงูุงูุชุฑุงุถู
}).setView([24.774265, 46.738586], 13); // ุชุนููู ุงููุฑูุฒ ุงูุงูุชุฑุงุถู ููุฎุฑูุทุฉ ุนูุฏ ุงูุฅุญุฏุงุซูุงุช (ุงูุฑูุงุถุ ุงูุณุนูุฏูุฉ) ูุน ูุณุชูู ุชูุจูุฑ 13

// ูุชุบูุฑุงุช ูุชุชุจุน ุงููููุน ูุญุฑูุฉ ุงููุณุชุฎุฏู
let marker = null; // ูุคุดุฑ ุงููููุน (marker) ุนูู ุงูุฎุฑูุทุฉ
let path = []; // ูุตูููุฉ ูุชุฎุฒูู ููุงุท ุงููุณุงุฑ (ูุชู ุงุณุชุฎุฏุงููุง ูุฑุณู ุงููุณุงุฑ ุงูุฐู ูุชุญุฑู ุนููู ุงููุณุชุฎุฏู)
let polyline = null; // ุฎุท ูุชุนุฏุฏ ุงููุทุน ูุฑุณู ุงููุณุงุฑ
let isFirstUpdate = true; // ูุชุบูุฑ ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงูุช ูุฐู ุฃูู ูุฑุฉ ูุชู ูููุง ุชุญุฏูุซ ุงููููุน
let currentPosition = null; // ูุชุบูุฑ ูุชุฎุฒูู ุงููููุน ุงูุญุงูู ูููุณุชุฎุฏู
let previousHeading = 0; // ูุชุบูุฑ ูุชุฎุฒูู ุงูุงุชุฌุงู ุงูุณุงุจู ูููุณุชุฎุฏู

// ุฅุถุงูุฉ ุทุจูุฉ ุฎุฑุงุฆุท ูู OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap' // ุฅุถุงูุฉ ูุณุจุฉ ุงููุตุฏุฑ ูุญููู OpenStreetMap
}).addTo(map); // ุฅุถุงูุฉ ุงูุทุจูุฉ ุฅูู ุงูุฎุฑูุทุฉ

let locationsMarkers = []; // ูุตูููุฉ ูุชุฎุฒูู ูุงุฑูุฑุงุช ุงูููุงูุน

// ุงูุญุตูู ุนูู ุนูุงุตุฑ HTML ูุนุฑุถ ุงูุณุฑุนุฉ ูุฒุฑ ุชูุณูุท ุงูุฎุฑูุทุฉ
const speedElement = document.getElementById('speed'); // ุนูุตุฑ HTML ูุนุฑุถ ุงูุณุฑุนุฉ
const centerButton = document.getElementById('centerButton'); // ุฒุฑ ูุชูุณูุท ุงูุฎุฑูุทุฉ ุนูู ุงููููุน ุงูุญุงูู

// ุฏุงูุฉ ูุชุญุฏูุซ ุงููููุน ุนูู ุงูุฎุฑูุทุฉ ุนูุฏ ุชุบููุฑ ุงููููุน ุงูุฌุบุฑุงูู
function updateLocation(position) {
    // ุงุณุชุฎุฑุงุฌ ุงูุฅุญุฏุงุซูุงุช ูุงูุณุฑุนุฉ ูุงูุงุชุฌุงู ูู ูุงุฆู ุงููููุน ุงูุฌุบุฑุงูู
    const lat = position.coords.latitude; // ุฎุท ุงูุนุฑุถ
    const lng = position.coords.longitude; // ุฎุท ุงูุทูู
    const speed = position.coords.speed * 3.6; // ุชุญููู ุงูุณุฑุนุฉ ูู ู/ุซ ุฅูู ูู/ุณ
    const heading = position.coords.heading !== null ? position.coords.heading : previousHeading; 
    // ุงุณุชุฎุฏุงู ุงูุงุชุฌุงู ูู ุงููููุน ุงูุฌุบุฑุงููุ ุฃู ุงูุงุชุฌุงู ุงูุณุงุจู ุฅุฐุง ูู ููู ูุชุงุญูุง

    // ุชุญุฏูุซ ุงููููุน ุงูุญุงูู ูุงูุงุชุฌุงู ุงูุณุงุจู
    currentPosition = { lat, lng };
    previousHeading = heading;

    // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุคุดุฑ (marker) ุบูุฑ ููุฌูุฏุ ูุฅุฐุง ูู ููู ููุฌูุฏูุง ูุชู ุฅูุดุงุคู
    if (!marker) {
        marker = L.marker([lat, lng], { 
            icon: arrowIcon // ุชุนููู ุฃููููุฉ ุงูุณูู ุงููุฎุตุตุฉ
        }).bindPopup(createPopupContent(speed, lat, lng)) // ุชุนููู ูุงูุฐุฉ ููุจุซูุฉ ุชุญุชูู ุนูู ุจูุงูุงุช ุงููููุน
        .addTo(map); // ุฅุถุงูุฉ ุงููุคุดุฑ ุฅูู ุงูุฎุฑูุทุฉ
        
        // ุชุญุฏูุซ ุฏูุฑุงู ุฃููููุฉ ุงูุณูู ููู ุงูุงุชุฌุงู ุงูุญุงูู
        const arrowElement = marker.getElement().querySelector('.arrow');
        if (arrowElement) {
            arrowElement.style.transform = `rotate(${heading}deg)`; // ุชุฏููุฑ ุงูุณูู ููุชุฌู ูุญู ุงูุงุชุฌุงู ุงูุตุญูุญ
        }
    } else {
        // ุฅุฐุง ูุงู ุงููุคุดุฑ ููุฌูุฏูุงุ ูุชู ุชุญุฏูุซ ูููุนู ููุญุชูู ุงููุงูุฐุฉ ุงูููุจุซูุฉ
        marker.setLatLng([lat, lng])
             .setPopupContent(createPopupContent(speed, lat, lng)); 

        // ุชุญุฏูุซ ุฏูุฑุงู ุฃููููุฉ ุงูุณูู ุจูุงุกู ุนูู ุงูุงุชุฌุงู ุงูุฌุฏูุฏ
        const arrowElement = marker.getElement().querySelector('.arrow');
        if (arrowElement) {
            arrowElement.style.transform = `rotate(${heading}deg)`;
        }
    }

    // ุฅุถุงูุฉ ุงููููุน ุงูุฌุฏูุฏ ุฅูู ูุณุงุฑ ุงูุญุฑูุฉ
    path.push([lat, lng]);

    // ุฅุฐุง ูุงู ููุงู ูุณุงุฑ ุณุงุจูุ ูุชู ุญุฐูู ูู ุงูุฎุฑูุทุฉ
    if (polyline) map.removeLayer(polyline);

    // ุฑุณู ูุณุงุฑ ุฌุฏูุฏ ุจุงุณุชุฎุฏุงู ุงูููุงุท ุงููุฎุฒูุฉ
    polyline = L.polyline(path, {color: 'red'}).addTo(map);

    // ุชุญุฏูุซ ุนูุตุฑ ุนุฑุถ ุงูุณุฑุนุฉ ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู
    speedElement.textContent = `ุงูุณุฑุนุฉ: ${speed.toFixed(1)} ูู/ุณ`;

    // ุนูุฏ ุฃูู ุชุญุฏูุซ ููุทุ ูุชู ุถุจุท ุนุฑุถ ุงูุฎุฑูุทุฉ ุนูู ุงููููุน ุงูุญุงูู
    if (isFirstUpdate) {
        map.setView([lat, lng], 13);
        isFirstUpdate = false;
    }

    // ุญูุธ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฅุฐุง ูุงูุช ุงูุฏุงูุฉ ูุชุงุญุฉ
    if (typeof window.saveToDB === 'function') {
        window.saveToDB(lat, lng, speed.toFixed(1), heading);
    }
}

// ุฏุงูุฉ ููุนุงูุฌุฉ ุฃุฎุทุงุก ุชุญุฏูุฏ ุงููููุน ุงูุฌุบุฑุงูู
function handleError(error) {
    console.error('Geolocation error:', error); // ุทุจุงุนุฉ ุงูุฎุทุฃ ูู ูุญุฏุฉ ุงูุชุญูู
    speedElement.textContent = 'ุฎุทุฃ ูู ุชุญุฏูุฏ ุงููููุน ุงููุฑ ููุชุญุฏูุซ ๐!'; // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู
}

// ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุชุตูุญ ูุฏุนู ุชุญุฏูุฏ ุงููููุน ุงูุฌุบุฑุงูู
if (navigator.geolocation) {
    // ูุชุงุจุนุฉ ุชุบููุฑุงุช ุงููููุน ุจุดูู ูุณุชูุฑ
    navigator.geolocation.watchPosition(updateLocation, handleError, {
        enableHighAccuracy: true, // ุงุณุชุฎุฏุงู ุฃุนูู ุฏูุฉ ููููุฉ ูู ุชุญุฏูุฏ ุงููููุน
        maximumAge: 30000, // ุงุณุชุฎุฏุงู ุงููููุน ุงููุญููุธ ููุฏุฉ 30 ุซุงููุฉ ูุจู ุทูุจ ูููุน ุฌุฏูุฏ
        timeout: 27000 // ูููุฉ ุงูุชุธุงุฑ ููุฏุฉ 27 ุซุงููุฉ ูุจู ุธููุฑ ุฎุทุฃ ุฅุฐุง ูู ูุชู ุงูุญุตูู ุนูู ุงููููุน
    });
}

// ุฅุถุงูุฉ ูุณุชูุน ูุญุฏุซ ุชุบููุฑ ุญุฌู ุงููุงูุฐุฉ ูุฅุนุงุฏุฉ ุถุจุท ุญุฌู ุงูุฎุฑูุทุฉ ุชููุงุฆููุง
window.addEventListener('resize', () => {
    map.invalidateSize(); // ุชุญุฏูุซ ุญุฌู ุงูุฎุฑูุทุฉ ุนูุฏ ุชุบููุฑ ุญุฌู ุงููุงูุฐุฉ
});

// ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงูุชูุจูุฑ ูุงูุชุตุบูุฑ ุฅูู ุงูุฎุฑูุทุฉ ูู ุงูุฒุงููุฉ ุงููููู ุงูุณูููุฉ
L.control.zoom({
    position: 'bottomright' // ุชุญุฏูุฏ ูููุน ุนูุงุตุฑ ุงูุชุญูู ูู ุงูุชูุจูุฑ ูุงูุชุตุบูุฑ
}).addTo(map);

// ุฏุงูุฉ ูุชูุณูุท ุงูุฎุฑูุทุฉ ุนูู ุงููููุน ุงูุญุงูู ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ุงูุชูุณูุท
function focusOnLocation() {
    if (currentPosition) { // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ููุงู ูููุน ูุชุงุญ
        map.setView([currentPosition.lat, currentPosition.lng], 13); // ุถุจุท ุงูุฎุฑูุทุฉ ุนูู ุงููููุน ุงูุญุงูู
        marker.openPopup(); // ูุชุญ ุงููุงูุฐุฉ ุงูููุจุซูุฉ ูููุคุดุฑ
        setTimeout(() => marker.closePopup(), 3000); // ุฅุบูุงู ุงููุงูุฐุฉ ุชููุงุฆููุง ุจุนุฏ 3 ุซูุงูู
    } else {
        alert("ูุง ููุฌุฏ ูููุน ูุชุงุญ ุญุงูููุง!"); // ุชูุจูู ุงููุณุชุฎุฏู ูู ุญุงูุฉ ุนุฏู ุชููุฑ ูููุน
    }
} 

// ุฑุจุท ุฒุฑ ุงูุชูุณูุท ุจูุธููุฉ ุงูุชุฑููุฒ ุนูู ุงููููุน
document.getElementById('centerButton').addEventListener('click', focusOnLocation);

// ุฏุงูุฉ ูุฅูุดุงุก ูุญุชูู ุงููุงูุฐุฉ ุงูููุจุซูุฉ ุงูุชู ุชุธูุฑ ุนูุฏ ุงูููุฑ ุนูู ุงููุคุดุฑ
function createPopupContent(speed, lat, lng) {
    return `
        <div dir="rtl" style="text-align: right;">
            <h4 style="margin: 5px 0;">ูุนูููุงุช ุงููุณุชุฎุฏู</h4>
            <hr style="margin: 5px 0;">
            <b>ุงูุงุณู:</b> ${window.userInfo?.username || 'ุบูุฑ ูุนุฑูู'}<br>
            <b>ุงูุฅูููู:</b> ${window.userInfo?.email || 'ุบูุฑ ูุนุฑูู'}<br>
            <b>ุงูุณุฑุนุฉ:</b> ${speed.toFixed(1)} ูู/ุณ<br>
            <b>ุงูุฅุญุฏุงุซูุงุช:</b><br>
            ${lat.toFixed(6)}, ${lng.toFixed(6)}
        </div>
    `;
}