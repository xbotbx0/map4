<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تتبع الموقع الحي</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: center center;
        }

    </style>

    <link rel="stylesheet" href="main.css"/></head>
<body>


    <div id="map"></div>
    <div id="speed" onclick="location.reload();" >السرعة: 0 كم/س</div>


    <nav class="nav-bar">
        <div class="nav-buttons">
            <button class="nav-button" title="القائمة">
                <i class="fas fa-bars"></i>
            </button>
            <button class="nav-button" title="تعديل">
                <i class="fas fa-edit"></i>
            </button>
            
            <button class="nav-button" id="centerButton"  title="توسيط الموقع">
                <i class="fas fa-crosshairs"></i>
            </button>

            </button>
           <button class="nav-button logout-btn" title="تسجيل الخروج">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </nav>












    

    <!-- Firebase و Leaflet scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script type="module">
        // استيراد الوظائف اللازمة من Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, update, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    
        // استيراد دوال الوصول إلى البيانات من Firebase
        import { get, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    
        // تكوين Firebase باستخدام الإعدادات الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyB9ZqQCZG9g3qclDz-kLHrNQparJT_iBXc", // مفتاح API للتطبيق
            authDomain: "mypro-d8761.firebaseapp.com", // نطاق المصادقة
            databaseURL: "https://mypro-d8761-default-rtdb.firebaseio.com", // عنوان قاعدة البيانات
            projectId: "mypro-d8761", // معرف المشروع في Firebase
            storageBucket: "mypro-d8761.appspot.com", // حاوية التخزين
            messagingSenderId: "439741574644", // معرف مرسل الرسائل
            appId: "1:439741574644:web:50b693546c7d32a5579da1" // معرف التطبيق في Firebase
        };
    
        // تهيئة التطبيق باستخدام التكوين الذي تم تحديده
        const app = initializeApp(firebaseConfig); // تهيئة التطبيق مع إعدادات Firebase
        const auth = getAuth(app); // الحصول على خدمة المصادقة
        const db = getDatabase(app); // الحصول على قاعدة البيانات
    
        // مراقبة حالة المستخدم (إذا كان قد سجل الدخول أم لا)
        onAuthStateChanged(auth, (user) => {
            if (user) {  // إذا كان المستخدم قد سجل الدخول
                console.log("المستخدم مسجل دخول:", user.uid); // عرض معرف المستخدم المسجل دخوله
                const userRef = ref(db, 'users/' + user.uid);  // تحديد مرجع بيانات المستخدم في قاعدة البيانات
    
                // إعداد وظيفة الحذف التلقائي عند قطع الاتصال (تم التعليق هنا)
                // onDisconnect(userRef).remove();  // حذف البيانات عندما ينقطع الاتصال
    
                // دالة لحفظ بيانات الموقع والسرعة في قاعدة البيانات
                window.saveToDB = (lat, lng, speed) => {
                    console.log("حفظ البيانات للمستخدم:", user.uid, { lat, lng, speed }); // طباعة بيانات الموقع والسرعة
                    
                    // تحديث بيانات المستخدم في قاعدة البيانات
                    update(userRef, {
                        latitude: lat, // تحديث خط العرض
                        longitude: lng, // تحديث خط الطول
                        speed: speed, // تحديث السرعة
                        timestamp: Date.now() // تحديث الطابع الزمني
                    }).then(() => {
                        console.log("تم حفظ البيانات بنجاح"); // طباعة رسالة نجاح
                    }).catch((error) => {
                        console.error('خطأ في حفظ البيانات:', error); // طباعة رسالة خطأ في حال فشل حفظ البيانات
                    });
    
                    // إضافة مستمع لتحديث بيانات المستخدم في الوقت الحقيقي
                    onValue(userRef, (snapshot) => {
                        const userData = snapshot.val(); // الحصول على بيانات المستخدم من قاعدة البيانات
                        window.userInfo = {
                            username: userData?.username || 'غير معروف', // الحصول على اسم المستخدم
                            email: user.email, // الحصول على البريد الإلكتروني للمستخدم
                            speed: userData?.speed || 0, // الحصول على السرعة
                            coords: userData ? [userData.latitude, userData.longitude] : [0, 0] // الحصول على الإحداثيات
                        };
                    });
                };
            } else {
                window.location.href = "login.html"; // إذا لم يكن المستخدم مسجلاً دخوله، إعادة التوجيه إلى صفحة تسجيل الدخول
            }
        });
    
        // إضافة حدث لتسجيل الخروج عند الضغط على زر الخروج
        document.querySelector('.logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth); // تسجيل الخروج من Firebase
                window.location.href = 'login.html'; // إعادة التوجيه إلى صفحة تسجيل الدخول بعد الخروج
            } catch (error) {
                console.error("خطأ في تسجيل الخروج:", error); // طباعة رسالة خطأ في حال فشل تسجيل الخروج
                alert("حدث خطأ أثناء محاولة تسجيل الخروج"); // عرض رسالة تنبيه في حال حدوث خطأ
            }
        });
    
    </script>
    







<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->








<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js"></script>
<script>
    // تعريف الرمز النابض (الرمز الذي يظهر على الخريطة ليعكس الحركة)
    const redPulseIcon = L.divIcon({
        className: 'pulsing-marker', // تخصيص اسم الكلاس
        iconSize: [20, 20], // حجم الرمز
        iconAnchor: [10, 10] // نقطة التثبيت داخل الرمز
    });

    // تهيئة الخريطة بموقع البداية
    let map = L.map('map', {
        zoomControl: false // إيقاف التحكم في التكبير/التصغير الافتراضي
    }).setView([24.774265, 46.738586], 13); // تعيين الموقع الأولي (خط العرض، خط الطول) ومستوى التكبير

    // المتغيرات
    let marker = null; // لتخزين المؤشر
    let path = []; // لتخزين المسار الذي سيتبعه المستخدم
    let polyline = null; // لتخزين المسار المتصل بين المواقع
    let isFirstUpdate = true; // لتحديد ما إذا كان هذا هو التحديث الأول للموقع
    let currentPosition = null; // لتخزين الموقع الحالي
    let isRotationEnabled = true; // لتحديد ما إذا كانت خاصية التدوير مفعلة

    // إضافة طبقة الخريطة من OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // العنصر الذي يعرض السرعة
    const speedElement = document.getElementById('speed');
    const centerButton = document.getElementById('centerButton'); // مرجع لزر التوسيط على الخريطة
    const rotateButton = document.getElementById('rotateButton'); // مرجع لزر التدوير

    // عنصر الخريطة لتطبيق التدوير
    const mapContainer = document.getElementById('map');

    // تحديث زاوية الخريطة بناءً على اتجاه المستخدم
    function rotateMap(degrees) {
        mapContainer.style.transform = `rotate(${360 - degrees}deg)`;
    }

    // الحصول على اتجاه الهاتف (يعمل على بعض الأجهزة)
    window.addEventListener('deviceorientation', (event) => {
        if (isRotationEnabled && event.alpha !== null) {
            rotateMap(event.alpha);
        }
    });

    // دالة لتحديث الموقع بشكل مستمر
    function updateLocation(position) {
        const lat = position.coords.latitude; // استخراج خط العرض
        const lng = position.coords.longitude; // استخراج خط الطول
        const speed = position.coords.speed * 3.6; // تحويل السرعة من متر/ثانية إلى كم/ساعة
        const heading = position.coords.heading; // اتجاه الحركة بالدرجات

        currentPosition = { lat, lng }; // تحديث الموقع الحالي

        // إذا لم يكن هناك مؤشر، سيتم إضافته على الخريطة
        if (!marker) {
            marker = L.marker([lat, lng], { icon: redPulseIcon }) // إضافة رمز نابض على الخريطة
                .bindPopup(createPopupContent(speed, lat, lng)) // ربط المحتوى بالنوافذ المنبثقة
                .addTo(map);
        } else {
            marker.setLatLng([lat, lng]) // تحديث موقع المؤشر
                .setPopupContent(createPopupContent(speed, lat, lng)); // تحديث محتوى النافذة المنبثقة
        }

        // إضافة الإحداثيات إلى المسار
        path.push([lat, lng]);

        // إذا كان هناك مسار سابق، يتم إزالته
        if (polyline) map.removeLayer(polyline);
        polyline = L.polyline(path, {color: 'red'}).addTo(map); // رسم المسار على الخريطة باللون الأحمر

        // تحديث السرعة المعروضة
        speedElement.textContent = `السرعة: ${speed.toFixed(1)} كم/س`;

        // إذا كان هذا هو التحديث الأول، يتم تكبير الخريطة إلى الموقع الحالي
        if (isFirstUpdate) {
            map.setView([lat, lng], 13);
            isFirstUpdate = false;
        }

        // تدوير الخريطة بناءً على اتجاه الحركة
        if (isRotationEnabled && heading !== null) {
            rotateMap(heading);
        }

        // حفظ البيانات في Firebase إذا كانت الدالة موجودة
        if (typeof window.saveToDB === 'function') {
            window.saveToDB(lat, lng, speed.toFixed(1));
        }
    }

    // دالة لمعالجة الأخطاء في تحديد الموقع
    function handleError(error) {
        console.error('Geolocation error:', error);
        speedElement.textContent = 'خطأ في تحديد الموقع انقر للتحديث 🔄!'; // عرض رسالة خطأ
    }

    // إذا كانت خاصية تحديد الموقع مدعومة، نبدأ في مراقبة الموقع
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(updateLocation, handleError, {
            enableHighAccuracy: true, // تفعيل الدقة العالية
            maximumAge: 30000, // الحد الأقصى لعمر البيانات المخزنة
            timeout: 27000 // الحد الأقصى للوقت قبل انقضاء التحديد
        });
    }

    // تحديث حجم الخريطة عند تغيير حجم الشاشة
    window.addEventListener('resize', () => {
        map.invalidateSize(); // تحديث حجم الخريطة
    });

    // إضافة تحكم في التكبير/التصغير مع تغيير الموضع إلى أسفل يمين الصفحة
    L.control.zoom({
        position: 'bottomright'
    }).addTo(map);

    // دالة التوسيط المعدلة التي تركز على الموقع الحالي
    function focusOnLocation() {
        if (currentPosition) {
            map.setView([currentPosition.lat, currentPosition.lng], 13); // توسيط الخريطة على الموقع الحالي
            marker.openPopup(); // فتح النافذة المنبثقة للمؤشر
            setTimeout(() => marker.closePopup(), 3000); // إغلاق النافذة المنبثقة بعد 3 ثواني
        } else {
            alert("لا يوجد موقع متاح حاليًا!"); // إذا لم يكن هناك موقع متاح، عرض تنبيه
        }
    }

    // إضافة حدث للنقر على زر التوسيط
    centerButton.addEventListener('click', focusOnLocation);

    // دالة لإنشاء محتوى النافذة المنبثقة
    function createPopupContent(speed, lat, lng) {
        return `
            <div dir="rtl" style="text-align: right;">
                <h4 style="margin: 5px 0;">معلومات المستخدم</h4>
                <hr style="margin: 5px 0;">
                <b>الاسم:</b> ${window.userInfo?.username || 'غير معروف'}<br>
                <b>الإيميل:</b> ${window.userInfo?.email || 'غير معروف'}<br>
                <b>السرعة:</b> ${speed.toFixed(1)} كم/س<br>
                <b>الإحداثيات:</b><br>
                ${lat.toFixed(6)}, ${lng.toFixed(6)}
            </div>
        `;
    }

    // دالة لتفعيل وإلغاء تفعيل خاصية التدوير
    function toggleRotation() {
        isRotationEnabled = !isRotationEnabled;
        rotateButton.classList.toggle('active', isRotationEnabled);
        if (!isRotationEnabled) {
            mapContainer.style.transform = 'rotate(0deg)';
        }
    }

    // إضافة حدث للنقر على زر التدوير
    rotateButton.addEventListener('click', toggleRotation);
</script>













</body>
</html>


















